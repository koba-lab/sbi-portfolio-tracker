# Claude Code 開発ガイドライン

このドキュメントは、Claude Codeがこのプロジェクトで従うべき振る舞いとルールを定義します。

## 基本原則

### 1. 仕様書駆動開発
- **実装前に必ずdocs/以下の仕様書を確認**
- 仕様書と実装に差異がある場合は、実装前に確認を求める
- コードは仕様書の実現手段であり、仕様書が主

### 2. 簡潔性の重視
- **過度な説明を避ける** - コードや仕様書を見れば分かることは説明しない
- **実装詳細の羅列を避ける** - メソッド一覧などメンテナンス負担になる記載は最小限に
- **要点のみを伝える** - ユーザーが求めていることに直接答える

### 3. 段階的な複雑性導入
- Phase 1: 動く最小限の実装
- Phase 2: 必要に応じた改善
- Phase 3: 高度な最適化
- **過度な先取り設計を避ける**

## 技術的ルール

### 必ず確認するドキュメント
1. `docs/OVERVIEW.md` - プロジェクトの目的
2. `docs/ARCHITECTURE.md` - システム設計
3. `docs/DECISIONS.md` - 技術選定の背景
4. `docs/DOMAIN_MODEL.md` - ビジネスロジック
5. `docs/INFRASTRUCTURE.md` - 技術実装詳細

### 技術スタック（確定）
- Runtime: Deno 2.x
- Framework: Fastify + TSyringe
- ORM: Prisma 6.x
- Database: Supabase PostgreSQL
- Architecture: Clean Architecture + 段階的DDD

### コーディング規約
- `any`型禁止 → `unknown`使用
- 外部ライブラリは`npm:`プレフィックス
- Domain層は純粋TypeScript（外部依存なし）
- エラーは適切に型付け

## Claude Codeの振る舞い

### してほしいこと
1. **確認を求める** - 大きな変更や仕様の解釈が必要な場合
2. **要点を伝える** - 実装内容より「なぜ」「何を」を重視
3. **仕様書を更新** - 重要な決定事項があれば`docs/DECISIONS.md`に追記

### してほしくないこと
1. **冗長な説明** - 「以下のコードを実装します...」などの前置き
2. **実装詳細の羅列** - メソッド一覧、プロパティ一覧など
3. **仕様書への実装詳細記載** - コードで分かることは書かない
4. **過度な先読み** - 要求されていない機能の実装

## 自己改善メカニズム

### フィードバックログ
開発中の気づきや改善点を記録：

```markdown
<!-- FEEDBACK_LOG -->
<!-- 日付: 内容 -->
<!-- 例: 2024-10-05: 環境変数名はより明確に（DIRECT_URL → DATABASE_MIGRATION_URL） -->
<!-- FEEDBACK_LOG_END -->
```

### 定期レビュートリガー
- 10回のやり取りごとに「仕様書と実装の整合性確認が必要か？」を提案
- Phase移行時に「次のPhaseに必要なリファクタリングはあるか？」を確認

## プロジェクト固有の注意点

### このプロジェクトの特徴
- 個人利用前提（セルフホスト）
- 無料枠での運用を重視
- DDDの学習も目的の一つ

### よくある質問への標準回答
- Q: なぜDenoか？ → A: Supabaseとの親和性、TypeScript標準サポート
- Q: なぜPrismaか？ → A: 型安全性、Deno対応、「イケてる技術」
- Q: なぜFastifyか？ → A: 軽量高速、NestJSは重い

## 個人設定の参照

個人的な背景や好みは`.claude/CLAUDE.local.md`（gitignore対象）に記載される場合があります。
存在する場合は参照してください。

---

<!-- FEEDBACK_LOG -->
<!-- 2024-10-05: 初版作成 - 今回の会話を基に基本ルール策定 -->
<!-- 2025-01-05: 【重要】Denoプロジェクトでは基本的にdeno taskを使用、npxは最小限に -->
<!-- 2025-01-05: 【重要】タスク名は実装技術を隠蔽する（×supabase:migrate → ○db:migrate） -->
<!-- 2025-01-05: 【重要】ファイル生成は必ずCLIコマンドを使用（手動作成禁止） -->
<!-- 2025-01-05: 【重要】実装前に必ずドキュメントを確認（思い込み禁止） -->
<!-- 2025-01-05: 【重要】ドメインモデルとDB設計の整合性を常に確認 -->
<!-- 2025-01-05: 【反省】同じミスを繰り返している - このログを必ず確認すること -->

<!-- ===== Deno環境変数とテストの教訓 ===== -->
<!-- 2025-01-05: 【教訓】Denoの--env-fileは既存環境変数を上書きしない仕様 -->
<!-- 2025-01-05: 【教訓】DevContainerのenv_fileが既存環境変数を設定するため注意 -->
<!-- 2025-01-05: 【解決】envコマンドで.env.testを注入する方法を採用 -->
<!-- 2025-01-05: 【重要】コマンドオプションの正確な名前を確認（--env → --env-file） -->
<!-- 2025-01-05: 【重要】環境変数の優先順位：既存 > --env-file > デフォルト -->
<!-- 2025-01-05: 【重要】GitHub Actionsでサービス名を使うにはcontainer実行が必要 -->
<!-- 2025-01-05: 【重要】ドキュメントの公式仕様を必ず確認、推測で実装しない -->
<!-- 2025-01-05: 【重要】テストではpostgres-test:5432で統一（CI/ローカル両対応） -->

<!-- ===== テスト構造の教訓 ===== -->
<!-- 2025-01-05: 【教訓】テストファイルはtests/配下に統一、src/内にテストを作らない -->
<!-- 2025-01-05: 【重要】問題が発生したら必ず教訓をCLAUDE.mdに記録し、次回に活かす -->
<!-- 2025-01-05: 【反省】エラー修正時は原因と対策を必ずドキュメントに残す -->
<!-- FEEDBACK_LOG_END -->